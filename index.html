<!DOCTYPE html>
<html>
    <head>
        <title>.index's Quest Menu</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="Web based ADB Host for Quest 2" />
        <meta property="og:title" content=".index's Quest Menu">
        <meta property="og:description" content="Web based ADB Host for Quest 2">
        <meta property="og:image" content="https://twhlynch.me/quest-ADB-menu-FULLVERSION/favicon.gif">
        <meta property="og:url" content="https://twhlynch.me/quest-ADB-menu-FULLVERSION">
        <meta property="og:type" content="website">
        <link rel="shortcut icon" href="favicon.gif" type="image/x-icon">
        <script src="https://cdn.jsdelivr.net/gh/webadb/webadb.js@master/webadb.js"></script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-BDS57RBQ3Q"></script>
        <script>
            if (window.location.href.includes('?code=')) {
                document.title += window.location.href.split("?code=")[1];
            }
        </script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-BDS57RBQ3Q');
        </script>
        <style>
            * {
                max-width: 500px;
                overflow-x: hidden;
                font-family: monospace;
            }
            body, html {
                padding: 1rem;
                margin: 0;
                background-color: #011;
            }
            input {
                width: 60%;
                border: #077 2px solid;
                background: #011;
                color: #077;
                padding: .5rem;
                border-radius: 0;
            }
            button {
                border: #077 2px solid;
                background: #011;
                color: #077;
                padding: .5rem;
                border-radius: 0;
                cursor: pointer;
                margin: 5px;
            }
            h1, h2, h3, p {
                color: #077
            }
            p {
                margin-bottom: 0;
            }
            a {
                color: inherit;
                text-decoration: none;
            }
            button:hover {
                background-color: #022;
            }
            *::-webkit-scrollbar {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1><a href="#">#</a> .index's Quest Menu</h1>
        <button onclick="connectUsb()" id="connectButton">Connect</button>
        <button><a href="https://ko-fi.com/dotindex">Give me more money?</a></button>
        <p id="err"></p>
        <div id="buttons" style="display: none;">
            <h2>Hertz</h2>
            <button onclick="setHz(45, 4)">11.25Hz</button>
            <button onclick="setHz(60, 4)">15Hz</button>
            <button onclick="setHz(72, 4)">18Hz</button>
            <button onclick="setHz(60, 3)">20Hz</button>
            <button onclick="setHz(90, 4)">22.5Hz</button>
            <button onclick="setHz(72, 3)">24Hz</button>
            <button onclick="setHz(60, 2)">30Hz</button>
            <button onclick="setHz(72, 2)">36Hz</button>
            <button onclick="setHz(120, 3)">40Hz</button>
            <button onclick="setHz(45)">45Hz</button>
            <button onclick="setHz(90, 2)">45Hz alt</button>
            <button onclick="setHz(60)">60Hz</button>
            <button onclick="setHz(72)">72Hz</button>
            <button onclick="setHz(90)">90Hz</button>
            <button onclick="setHz(120)">120Hz</button>
            <button onclick="setHz(120, 0)">max</button>
            <button onclick="setHz(45, 0)">max (lower fps)</button>
            <br><br>
            <input type="text" name="Hz" id="Hz" placeholder="Hz">
            <button onclick="setHz(document.getElementById('Hz').value)">Custom Hz</button>
            <h2>Performance</h2>
            <button onclick="performance(0, 0)">low performance</button>
            <button onclick="performance(1, 1)">med performance</button>
            <button onclick="performance(2, 2)">default performance</button>
            <button onclick="performance(3, 3)">performance boost</button>
            <button onclick="performance(3, 0)">GPU boost, CPU low</button>
            <button onclick="performance(0, 3)">CPU boost, GPU low</button>
            <button onclick="performance(3, 2)">GPU boost, CPU default</button>
            <button onclick="performance(2, 3)">CPU boost, GPU default</button>
            <h2>Resolution</h2>
            <button onclick="setRes(2000)">Res 2000 (Default)</button>
            <button onclick="setRes(3000)">Res 3000</button>
            <button onclick="setRes(4000)">Res 4000</button>
            <button onclick="setRes(1000)">Res 1000</button>
            <h2>Extras</h2>
            <button onclick="execute('am broadcast -a com.oculus.vrpowermanager.prox_close')">Keep Screen On</button>
            <button onclick="execute('am broadcast -a com.oculus.vrpowermanager.automation_disable')">allow screen timeout</button>
            <button onclick="execute('adb shell setprop debug.oculus.guardian_pause 1')">Disable guardian</button>
            <h2>Custom</h2>
            <input type="text" name="cmd" id="cmd" placeholder="cmd (without adb shell prefix)">
            <button onclick="execute(document.getElementById('cmd').value)">Custom Command</button>
            <h2>Check</h2>
            <button onclick="check()">check</button>
            <p id="checkOut"></p>
        </div>
        <script id="script">
            var connectButton = document.getElementById("connectButton");
            var err = document.getElementById("err");

            let decoder = new TextDecoder();
            let webusb = null;
            let adb = null;
            let shell = null;

            async function connectUsb() {
                try {
                    webusb = await Adb.open("WebUSB");
                    adb = await webusb.connectAdb("host::");
                } catch (e) {
                    err.innerText = "Error. Hit \"allow\" if prompted on Quest, then try again. If this persists more than 4 times, disable and enable USB debugging.";
                }
                if (adb != null) {
                    document.getElementById("buttons").style.display = "block";
                    err.innerText = "Success. If menu does not appear, reload page and try again.";
                } else {
                    err.innerText = "Error. Hit \"allow\" if prompted on Quest, then try again. If this persists more than 4 times, disable and enable USB debugging.";
                }
            }

            async function setHz(Hz, swap=1) {
                await execute(`setprop debug.oculus.refreshRate ${Hz}`);
                await execute(`setprop debug.oculus.swapInterval ${swap}`);
            }
            
            async function setRes(res) {
                await execute(`setprop debug.oculus.textureWidth ${res}`);
                await execute(`setprop debug.oculus.textureHeight ${res}`);
            }

            async function performance(gpu, cpu) {
                await execute(`setprop debug.oculus.gpuLevel ${gpu}`);
                await execute(`setprop debug.oculus.cpuLevel ${cpu}`);
            }

            async function check() {
                var checkOut = document.getElementById('checkOut');

                let w = await execute(`getprop debug.oculus.textureWidth`);
                let h = await execute(`getprop debug.oculus.textureHeight`);
                let swap = await execute(`getprop debug.oculus.swapInterval`);
                let hz = await execute(`getprop debug.oculus.refreshRate`);
                let fps = await execute(`getprop debug.oculus.fps`);
                let gpu = await execute(`getprop debug.oculus.gpuLevel`);
                let cpu = await execute(`getprop debug.oculus.cpuLevel`);

                checkOut.innerHTML = `${hz} / ${swap} = ${hz/swap} Hz<br>${fps} fps<br>${w}x${h}<br>GPU: ${gpu}, CPU: ${cpu}<br>^(range 0 - 3)`;
            }

            async function execute(cmd) {
                shell = await adb.shell(cmd);
                try {
                    let r = await shell.receive();
                    return decoder.decode(r.data);
                } catch {
                    return true;
                }
            }


            if (window.location.href.includes('?code=')) {
                let code = window.location.href.split("?code=")[1];
                let codes = [
                    "ETXCODEXD",
                    "INDEX0077"
                ];
                if (!codes.includes(code) || code.length < 5) {
                    document.getElementById("buttons").parentNode.removeChild(document.getElementById("buttons"));
                    connectUsb = null;
                    execute = null;
                    setHz = null;
                    setRes = null;
                    performance = null;
                    document.getElementById("script").parentNode.removeChild(document.getElementById("script"));
                    window.location.href = "https://ko-fi.com/dotindex";
                }
            } else {
                document.getElementById("buttons").parentNode.removeChild(document.getElementById("buttons"));
                connectUsb = null;
                execute = null;
                setHz = null;
                setRes = null;
                performance = null;
                document.getElementById("script").parentNode.removeChild(document.getElementById("script"));
                window.location.href = "https://ko-fi.com/dotindex";
            }
        </script>
    </body>
</html>
